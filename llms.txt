# Incursa Platform

> .NET 10 platform for SQL-backed distributed work-queue primitives (outbox/inbox, schedulers, leases) with claim-ack-abandon semantics and database-authoritative timing.

Primary solutions: `Incursa.Platform.slnx` and `Incursa.Platform.CI.slnx`. Packages live under `src/`, tests under `tests/`, docs under `docs/`, and SQL Server schema artifacts under `src/Incursa.Platform.SqlServer/Database/`.

## Getting Started
Install the core package and a provider (SqlServer or Postgres), register the scheduler/outbox/inbox services, and enable schema deployment if you want automatic table creation. Use discovery-based registration for multi-tenant scenarios.

## Core Patterns and APIs

Outbox, inbox, scheduler, fanout, and leases are built on a work-queue pattern: claim → ack → abandon, with database-authoritative timing. Use these primitives when you need durable background processing, predictable retries, and at-least-once delivery with idempotency guards.

## Module Overview (When to use / How it works)

- Incursa.Platform: Core abstractions and orchestration for platform primitives; provider packages supply concrete storage and schema deployment.
- Incursa.Platform.SqlServer / Postgres: Database-backed implementations of outbox/inbox/scheduler/fanout/leases/metrics with optional schema deployment.
- Incursa.Platform.InMemory: In-memory implementations of outbox/inbox/scheduler/fanout/leases for testing and single-process development.
- Incursa.Platform.Audit: Immutable audit timeline; write append-only events and query by anchors.
- Incursa.Platform.Correlation: Correlation context and header propagation to stitch workflows end-to-end.
- Incursa.Platform.Operations: Track long-running operations with progress, events, and stalled detection.
- Incursa.Platform.Observability: Shared conventions and helpers (event names, tag keys, emitters) for audit/ops/metrics consistency.
- Incursa.Platform.Idempotency: At-most-once semantics for a logical key with TryBegin/Complete/Fail.
- Incursa.Platform.ExactlyOnce: Best-effort exactly-once execution workflow with idempotency and optional verification probes.
- Incursa.Platform.Email: Outbox-driven email delivery with idempotency, send policies, and provider adapters.
- Incursa.Platform.Email.AspNetCore: ASP.NET Core DI helpers and hosted processing loop.
- Incursa.Platform.Webhooks: Provider-agnostic webhook ingestion; authenticate/classify/enqueue/handle with retries.
- Incursa.Platform.Webhooks.AspNetCore: ASP.NET Core endpoints and DI wiring for webhooks.
- Incursa.Platform.Modularity: Engine-first module model for UI, webhooks, and background workflows.
- Incursa.Platform.Modularity.AspNetCore: ASP.NET Core helpers for modularity hosting.
- Incursa.Platform.Modularity.Razor: Razor UI module integration.
- Incursa.Platform.Metrics.AspNetCore: ASP.NET Core OpenTelemetry/Prometheus exports.
- Incursa.Platform.Metrics.HttpServer: Self-hosted Prometheus scrape endpoint.
- Incursa.Platform.HealthProbe: Deploy-time healthcheck CLI with standardized exit codes.

## Modularity and Engines

Modularity provides engine descriptors and manifests to expose UI/webhook/worker capabilities. Use it when you need discovery and composition of modules with structured inputs/outputs.

## Observability and Operations

Observability focuses on consistent audit/operation/metric conventions. Operations track long-running jobs and provide progress snapshots; audit records immutable timeline events.

## Database and Schema

SQL Server schema scripts live under `src/Incursa.Platform.SqlServer/Database/`. Providers can auto-deploy schema or use manual scripts. Multi-database patterns use discovery and routers to span tenant databases.

## Specifications

Outbox, inbox, and join coordination specifications define behavior requirements and guarantees.
Provider-specific primitive specs and traceability live under `specs/providers/`:
- `sqlserver-primitives-spec.md`
- `postgres-primitives-spec.md`
- `inmemory-primitives-spec.md`
- `provider-conformance-matrix.md`
Cross-library interface quality specs and traceability live under `specs/libraries/`:
- `library-interface-quality-spec.md`
- `library-conformance-matrix.md`

## Testing

Tests use xUnit v3, Shouldly, and NSubstitute. Integration tests rely on Docker SQL Server and Postgres via Testcontainers.
Shared primitive conformance harnesses are in `tests/Incursa.Platform.TestUtilities/`.
SQL Server scheduler/lease conformance entry suites:
- `tests/Incursa.Platform.SqlServer.Tests/SqlSchedulerBehaviorTests.cs`
- `tests/Incursa.Platform.SqlServer.Tests/SqlSystemLeaseBehaviorTests.cs`
Postgres scheduler/lease conformance entry suites:
- `tests/Incursa.Platform.Postgres.Tests/PostgresSchedulerBehaviorTests.cs`
- `tests/Incursa.Platform.Postgres.Tests/PostgresSystemLeaseBehaviorTests.cs`
Provider quality automation and baselines:
- Fast quality lane: `.github/workflows/provider-fast-quality.yml`
- Docker-backed integration lane: `.github/workflows/provider-integration.yml`
- Scoped mutation lane: `.github/workflows/provider-mutation.yml`
- Cross-library fast lane: `.github/workflows/library-fast-quality.yml`
- Docker image pre-pull script: `scripts/testing/prepull-test-images.ps1`
- Coverage/mutation/traceability scripts: `scripts/quality/`
- Baseline report: `docs/quality/provider-quality-baseline.md`
- Cross-library baseline report: `docs/quality/library-hardening-baseline.md`
- In-memory portability checklist: `docs/quality/inmemory-portability-checklist.md`

## Smoke Web App

`tests/Incursa.Platform.SmokeWeb/` hosts a minimal ASP.NET Core web UI to exercise outbox, inbox, scheduler, fanout, and leases. `tests/Incursa.Platform.Smoke.AppHost/` is an Aspire app host that starts SQL Server + Postgres containers and the smoke site. Configure provider via `Smoke:Provider` (SqlServer, Postgres, InMemory) and supply connection strings as needed.

## Optional

Advanced patterns: multi-database routing, fanout/join coordination, and internal work-queue mechanics.
CLI tools: `tools/migrations` ships `bravellian-schema` for applying SQL Server/Postgres schema migrations from the command line.

## Repository Scope Governance

Scope boundary policy lives at `docs/quality/repo-scope-boundary.md`.
Automated guardrail runs via `scripts/quality/validate-platform-scope.ps1` using rules in `scripts/quality/platform-scope.rules.json`.
CI enforcement workflow: `.github/workflows/scope-boundary.yml`.
